parameters:
  - name:  azureServiceConnection
    type:  string
  - name: resourceGroup
    type: string
  - name: environment
    type: string

steps:
  - task:  AzureCLI@2
    displayName: 'Get App Service Names'
    inputs:
      azureSubscription: ${{ parameters. azureServiceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        # Get App Service names from resource group
        app1Name=$(az webapp list \
          --resource-group ${{ parameters.resourceGroup }} \
          --query "[?contains(name, 'app1')].name" -o tsv)
        
        app2Name=$(az webapp list \
          --resource-group ${{ parameters.resourceGroup }} \
          --query "[?contains(name, 'app2')].name" -o tsv)
        
        echo "##vso[task.setvariable variable=APP1_NAME]$app1Name"
        echo "##vso[task.setvariable variable=APP2_NAME]$app2Name"
        
        echo "App1 Name: $app1Name"
        echo "App2 Name: $app2Name"

  - task: AzureWebApp@1
    displayName: 'Deploy App1 (Frontend)'
    inputs:
      azureSubscription: ${{ parameters.azureServiceConnection }}
      appType: 'webAppLinux'
      appName:  $(APP1_NAME)
      resourceGroupName: ${{ parameters.resourceGroup }}
      package: '$(Pipeline.Workspace)/app1/app1.zip'
      runtimeStack: 'NODE|20-lts'
      startUpCommand: 'npm start'

  - task: AzureWebApp@1
    displayName:  'Deploy App2 (Backend)'
    inputs:
      azureSubscription: ${{ parameters. azureServiceConnection }}
      appType: 'webAppLinux'
      appName: $(APP2_NAME)
      resourceGroupName: ${{ parameters.resourceGroup }}
      package: '$(Pipeline.Workspace)/app2/app2.zip'
      runtimeStack: 'NODE|20-lts'
      startUpCommand: 'npm start'

  - task: AzureCLI@2
    displayName: 'Restart App Services'
    inputs:
      azureSubscription: ${{ parameters. azureServiceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az webapp restart --name $(APP1_NAME) --resource-group ${{ parameters.resourceGroup }}
        az webapp restart --name $(APP2_NAME) --resource-group ${{ parameters.resourceGroup }}
        
        # Wait for apps to be ready
        sleep 30