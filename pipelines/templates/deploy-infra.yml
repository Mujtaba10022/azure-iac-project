parameters:
  - name: azureServiceConnection
    type: string
  - name: resourceGroup
    type: string
  - name: location
    type: string
  - name: environment
    type: string

steps:
  - task: AzureCLI@2
    displayName: 'Create Resource Group'
    inputs: 
      azureSubscription: ${{ parameters.azureServiceConnection }}
      scriptType: 'bash'
      scriptLocation:  'inlineScript'
      inlineScript: |
        az group create \
          --name ${{ parameters.resourceGroup }} \
          --location ${{ parameters.location }} \
          --tags Environment=${{ parameters.environment }} ManagedBy=AzureDevOps

  - task: AzureCLI@2
    displayName: 'Deploy Bicep Template'
    inputs:
      azureSubscription: ${{ parameters. azureServiceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az deployment group create \
          --resource-group ${{ parameters.resourceGroup }} \
          --template-file iac/main. bicep \
          --parameters iac/parameters/${{ parameters.environment }}.parameters.json \
          --name "deployment-${{ parameters.environment }}-$(Build.BuildId)" \
          --verbose

  - task: AzureCLI@2
    displayName: 'Get Deployment Outputs'
    inputs:
      azureSubscription: ${{ parameters. azureServiceConnection }}
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        # Get deployment outputs and set pipeline variables
        outputs=$(az deployment group show \
          --resource-group ${{ parameters.resourceGroup }} \
          --name "deployment-${{ parameters.environment }}-$(Build. BuildId)" \
          --query properties.outputs)
        
        app1Url=$(echo $outputs | jq -r '. app1Url. value')
        app2Url=$(echo $outputs | jq -r '.app2Url.value')
        
        echo "##vso[task.setvariable variable=APP1_URL;isOutput=true]$app1Url"
        echo "##vso[task. setvariable variable=APP2_URL;isOutput=true]$app2Url"
        
        echo "App1 URL: $app1Url"
        echo "App2 URL: $app2Url"
    name: deploymentOutputs