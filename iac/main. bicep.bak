targetScope = 'resourceGroup'

param environment string
param location string = resourceGroup().location
param projectName string = 'GM'

@secure()
param sqlAdminLogin string

@secure()
param sqlAdminPassword string

var suffix = toLower('${projectName}${environment}${uniqueString(resourceGroup().id)}')

resource vnet 'Microsoft.Network/virtualNetworks@2023-05-01' = {
  name:  'vnet-${suffix}'
  location: location
  properties: {
    addressSpace: {
      addressPrefixes:  ['10.0.0.0/16']
    }
    subnets:  [
      {
        name: 'frontend-subnet'
        properties: {
          addressPrefix: '10.0.1.0/24'
        }
      }
      {
        name: 'backend-subnet'
        properties: {
          addressPrefix: '10.0.2.0/24'
        }
      }
    ]
  }
}

resource storageAccount 'Microsoft.Storage/storageAccounts@2023-01-01' = {
  name: take('st${suffix}', 24)
  location: location
  sku: { name: 'Standard_LRS' }
  kind: 'StorageV2'
  properties: {
    minimumTlsVersion: 'TLS1_2'
    supportsHttpsTrafficOnly: true
  }
}

output vnetId string = vnet.id
output storageAccountName string = storageAccount.name
resource appPlanFrontend 'Microsoft.Web/serverfarms@2023-01-01' = {
  name:  'asp-frontend-${suffix}'
  location:  location
  sku:  { name: 'B1', tier: 'Basic' }
  kind: 'linux'
  properties: { reserved: true }
}

resource appPlanBackend 'Microsoft.Web/serverfarms@2023-01-01' = {
  name: 'asp-backend-${suffix}'
  location: location
  sku:  { name: 'B1', tier:  'Basic' }
  kind: 'linux'
  properties: { reserved:  true }
}

resource app1 'Microsoft.Web/sites@2023-01-01' = {
  name: 'app1-${suffix}'
  location: location
  kind: 'app,linux'
  properties: {
    serverFarmId: appPlanFrontend.id
    httpsOnly: true
    siteConfig: {
      linuxFxVersion: 'NODE|20-lts'
      alwaysOn: false
      ftpsState: 'Disabled'
      minTlsVersion:  '1.2'
    }
  }
}

resource sqlServer 'Microsoft.Sql/servers@2023-05-01-preview' = {
  name: 'sql-${suffix}'
  location: location
  properties: {
    administratorLogin: sqlAdminLogin
    administratorLoginPassword: sqlAdminPassword
    minimalTlsVersion:  '1.2'
  }
}

resource sqlDatabase 'Microsoft.Sql/servers/databases@2023-05-01-preview' = {
  parent: sqlServer
  name: 'sqldb-${suffix}'
  location: location
  sku: { name: 'Basic', tier: 'Basic' }
}

resource sqlFirewallRule 'Microsoft.Sql/servers/firewallRules@2023-05-01-preview' = {
  parent: sqlServer
  name: 'AllowAzureServices'
  properties:  {
    startIpAddress: '0.0.0.0'
    endIpAddress: '0.0.0.0'
  }
}

output app1Url string = 'https://${app1.properties.defaultHostName}'
output app2Url string = 'https://${app2.properties.defaultHostName}'
output sqlServerFqdn string = sqlServer.properties.fullyQualifiedDomainName

